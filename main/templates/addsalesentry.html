{% extends 'main.html' %}
{% load static %}
{% block content %}
<div class="body-wrapper">
  <div class="container-fluid">
    <div class="row">
      {% for message in messages %}
      {% if message.tags == 'success' %}
      <div class="row justify-content-center">
        <div class="col-6 mt-1 mb=1 alert alert-success alert-dismissible fade show" role="alert">
          <strong>{{message}}</strong>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      </div>
      {% endif %}
      {% endfor %}
      <div class="col-12">
        <div class="card">
          <div class="px-4 py-3 border-bottom">
            <h4 class="card-title mb-0">Add Sales Entery</h4>
          </div>
          <form class="card-body p-4" enctype="multipart/form-data" method="post">
            {% csrf_token %}
            <div class="row">
              <div class="col-md-2">
                <div class="mb-4">
                  <label for="exampleInputtype" class="form-label">Delivery Boy Name</label>
                  <select class="form-select form-control-sm" id="exampleInputtype" name="DeliveryBoyName" tabindex="1"
                    required>
                    <option value="" selected>-- Selet --</option>
                    {% for i in DB %}
                    <option value="{{i.Name}}">{{i.Name}}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="col-md-2">
                <div class="mb-4">
                  <label for="exampleInputtype" class="form-label">Type Of Business</label>
                  <select class="form-select form-control-sm" id="exampleInputtype" name="TypeOfBusiness" tabindex="1"
                    required>
                    <option value="" selected>-- Selet --</option>
                    <option value="B2B">B2B</option>
                    <option value="B2C">B2C</option>
                  </select>
                </div>
              </div>
              <div class="col-md-2">
                <div class="mb-4">
                  <label for="exampleInputBillno" class="form-label">Delivery Time</label>
                  <input type="time" class="form-control " id="exampleInputBillno" name="DeliveryTime" placeholder=""
                    required>
                </div>
              </div>
              <div class="col-md-2">
                <div class="mb-4">
                  <label for="exampleInputInvoiceNo" class="form-label">Invoice No.</label>
                  <input type="text" class="form-control " id="exampleInputInvoiceNo" name="InvoiceNo" placeholder=""
                    required>
                  <input type="hidden" name="ProductId" value="{{ProductId}}">
                </div>
              </div>
              <div class="col-md-2">
                <label for="exampleInputtype" class="form-label">Party Name</label>
                <div class="mb-4">
                  <select class="select2 form-control  custom-select" name="PartyName" required>
                    <option>Select</option>
                    <optgroup label="">
                      {% for i in Party %}
                      <option value="{{i.PartyName}}">{{i.PartyName}}</option>
                      {% endfor %}
                    </optgroup>
                  </select>
                </div>
              </div>
              <div class="col-1 d-flex align-items-center"><a href="AddParty" class="btn btn-primary btn-lg"><i
                    class='ti ti-plus'></i></a></div>
              <hr>
              <div class="col-12">
                <div class="mb-2 row" id="Prodectselect2">
                  <div class="col-4">
                    <select class="select form-control" name="Product2">
                      <option>Product Name</option>
                      {% for i in stokes %}
                      <option value="{{i.ProductName}}/{{i.OldProductId}}/{{i.id}}">{{i.ProductName}} <b> MRP :
                        </b>{{i.MRP}} Quantity : {{i.Quantity}}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-1"><a href="AddProduct" class="btn btn-primary btn-lg"><i class='ti ti-plus'></i></a>
                  </div>
                </div>
              </div>
              <div class="col-12">
                <table class="table table-striped table-bordered display text-nowrap" id="thad">
                  <thead>
                    <tr>
                      <th>Prodect Name</th>
                      <th>Quantity</th>
                      <th>Purchase Inc. <br> Tax Price</th>
                      <th>Profit <br> Margin</th>
                      <th>Basic Sales Price <br> ( Per. Unit )</th>
                      <th>Tax <br> ( % )</th>
                      <th>Inc. Sales <br> Price</th>
                      <th>Total <br> Sales</th>
                      <th>MRP</th>
                    </tr>
                  </thead>
                  <tbody id="tbody">
                    {% for i in stock %}
                    <form method="post">
                      <tr>
                        <td class="mt-5">{{i.ProductName}}</td>
                        <td><input type="text" class="form-control text-center" name="Quantity" id="Quantity{{i.id}}"
                            value="{{i.Quantity}}"></td>
                        <td><input type="text" class="form-control text-center " name="MRP" id="MRP{{i.id}}"
                            value="{{i.MRP}}"></td>
                        <td><a type='button' class='btn btn-success bg-success btn-edit' data-sid='{{i.id}}'><i
                              class='ti ti-check'></i></a><a type='button' class='btn btn-danger bg-danger btn-del ms-2'
                            data-sid='{{i.id}}'><i class='ti ti-trash'></i></a></td>
                      </tr>
                    </form>
                    {% endfor %}
                  </tbody>
                  <tbody class="bg-white">
                    <tr class="bg-white">
                      <td colspan="4" class="bg-white"><span>
                          <center><b id="mes" class="text-danger"></b></center>
                        </span></td>
                    </tr>
                  </tbody>
                  <tfoot>
                    <tr>
                      <th colspan="7">
                        total Amount :
                      </th>
                      <th colspan="2">
                        <span id="tamount2">{{tamonut}}</span>
                      </th>
                    </tr>
                  </tfoot>
                </table>
              </div>
              <div class="col-12">
                <div class="gap-3">
                  <button class="btn btn-primary" type="submit">Save</button>
                  <button class="btn btn-primary" type="submit">Save & Print</button>
                  <a class="btn bg-danger-subtle text-danger" href="/DeliveryBoy">Cancel</a>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}
{% block script %}
<script src="{% static 'assets/js/jquery-3.7.1.js' %}"></script>
<script>
  function Stockswork(ProductName, OldProductId, id) {
    // console.log('/Stockswork/' + ProductName + '/' + OldProductId + '/' + id +'/Sales');
    $.ajax({
      url: '/Stockswork/' + ProductName + '/' + OldProductId + '/' + id + '/Sales',
      type: 'GET',
      success: function (resp) {
        x = resp.Sc
        output = ''
        for (i = 0; i < x.length; i++) {
          output += "<tr><td class=''>" + x[i].ProductName + "</td><td><input type='text' class='form-control text-center' id='Quantity" + x[i].id + "' value='" + x[i].Quantity + "'></td><td><input type=' text' class='form-control text-center' id='MRP" + x[i].id + "' value='" + x[i].MRP + "'></td><td><a type=' button' class='btn btn-success bg-success btn-edit' data-sid=" + x[i].id + "><i class='ti ti-check'></i></a><a type='button' class='btn btn-danger bg-danger btn-del ms-2' data-sid=" + x[i].id + "><i class='ti ti-trash'></i></a></td>"
        };
        $('#tbody').html(output);
        var tamount2 = document.getElementById("tamount2");
        tamount2.innerText = resp.tamonut;
        var tamount3 = document.getElementById("mes");
        tamount3.innerText = '';
      },
      error: function (resp) {
        console.log('Something went wrong');
      }
    });
  }
  $("#Prodectselect2 select[name='Product2']").on('change', function () {
    var $Productname = $(this);
    var $Productid = $("input[name='Productid']").val();
    if ($Productname.val() != '') {
      $.ajax({
        url: '/Stockswork/' + $Productname.val() + '/Sales',
        type: 'GET',
        success: function (resp) {
          x = resp.Sc
          output = ''
          for (i = 0; i < x.length; i++) {
            output += "<tr><td class=''>" + x[i].ProductName + "</td><td><input type='text' class='form-control text-center' id='Quantity" + x[i].id + "' value='" + x[i].Quantity + "'></td><td><input type=' text' class='form-control text-center' id='MRP" + x[i].id + "' value='" + x[i].MRP + "'></td><td><a type=' button' class='btn btn-success bg-success btn-edit' data-sid=" + x[i].id + "><i class='ti ti-check'></i></a><a type='button' class='btn btn-danger bg-danger btn-del ms-2' data-sid=" + x[i].id + "><i class='ti ti-trash'></i></a></td>"
          };
          $('#tbody').html(output);
          var tamount2 = document.getElementById("tamount2");
          tamount2.innerText = resp.tamonut;
          var tamount3 = document.getElementById("mes");
          tamount3.innerText = '';
        },
        error: function (resp) {
          console.log('Something went wrong');
        }
      });
    } else {
      console.log('Something went wrong');
    }
  });
  // delete data
  $("tbody").on('click', '.btn-del', function () {
    // console.log('delete btn clicked');
    let id = $(this).attr('data-sid');
    // console.log(id);
    mydata = { sid: id, type: 'Sales' };
    mythis = this;
    $.ajax({
      type: "POST",
      url: '/ProductsDelete',
      data: mydata,
      success: function (data) {
        if (data.status == 1) {
          $(mythis).closest("tr").fadeOut();
        }
        var tamount2 = document.getElementById("tamount2");
        tamount2.innerText = data.tamonut;
        var tamount3 = document.getElementById("mes");
        tamount3.innerText = '';
      }
    });
  });
  $("tbody").on('click', '.btn-edit', function () {
    // console.log('edit btn clicked');
    let id = $(this).attr('data-sid');
    let Quantity = '#Quantity' + id;
    let MRP = '#MRP' + id;
    let type = 'Sales';
    $.ajax({
      type: "POST",
      url: '/EditProducts',
      data: {
        sid: $(this).attr('data-sid'),
        Quantity: $(Quantity).val(),
        MRP: $(MRP).val(),
        type: type,
      },
      success: function (data) {
        if (data.msg) {
          var tamount2 = document.getElementById("mes");
          tamount2.innerText = data.msg;
        }
        else {
          var tamount2 = document.getElementById("tamount2");
          tamount2.innerText = data.tamonut;
          var tamount3 = document.getElementById("mes");
          tamount3.innerText = '';
        }

      }
    });
  });
</script>
{% endblock script %}